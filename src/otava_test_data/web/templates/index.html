<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otava Test Data Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>Otava Test Data Visualizer</h1>
        <p class="subtitle">Interactive visualization of change point detection with Apache Otava</p>
    </header>

    <main>
        <!-- Data Generation Controls -->
        <section class="controls">
            <div class="control-group">
                <label for="generator-select">Generator:</label>
                <select id="generator-select">
                    <optgroup label="Basic Building Blocks">
                        {% for name, info in generators.items() if info.category == 'basic' %}
                        <option value="{{ name }}" data-has-cp="{{ info.has_change_points|lower }}">
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Advanced Patterns">
                        {% for name, info in generators.items() if info.category == 'advanced' %}
                        <option value="{{ name }}" data-has-cp="{{ info.has_change_points|lower }}">
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>

            <div class="control-group">
                <label for="length-input">Length:</label>
                <input type="range" id="length-input" min="50" max="1000" value="{{ default_length }}" step="10">
                <span id="length-value">{{ default_length }}</span>
            </div>

            <div class="control-group">
                <label for="seed-input">Seed:</label>
                <input type="number" id="seed-input" value="42" min="0" max="9999">
            </div>

            <div id="dynamic-params" class="dynamic-params">
                <!-- Dynamic parameters will be inserted here -->
            </div>
        </section>

        <!-- Otava Analysis Controls -->
        <section class="controls otava-controls">
            <h3 class="section-title">Otava Analysis</h3>

            <div class="control-group">
                <label for="run-otava-checkbox">
                    <input type="checkbox" id="run-otava-checkbox" checked>
                    Run Otava Detection
                </label>
            </div>

            <div class="control-group">
                <label for="window-len-input">Window Length:</label>
                <input type="number" id="window-len-input" value="30" min="5" max="100" step="5">
            </div>

            <div class="control-group">
                <label for="max-pvalue-input">Max P-Value:</label>
                <input type="number" id="max-pvalue-input" value="0.05" min="0.001" max="0.5" step="0.01">
            </div>

            <div class="control-group">
                <label for="tolerance-input">Match Tolerance:</label>
                <input type="number" id="tolerance-input" value="5" min="0" max="50" step="1">
            </div>

            <div class="control-actions">
                <button id="generate-btn" class="btn-primary">Generate & Analyze</button>
                <button id="show-all-btn" class="btn-secondary">Compare All Patterns</button>
            </div>
        </section>

        <!-- Generator Info -->
        <section class="generator-info" id="generator-info">
            <h3 id="generator-title">Constant</h3>
            <p id="generator-description">Constant value: S = x, x, x, x...</p>
            <div id="change-point-info" class="change-point-badge hidden">
                <span class="badge">Has Change Points</span>
            </div>
        </section>

        <!-- Chart Legend -->
        <section class="chart-legend">
            <div class="legend-item">
                <span class="legend-marker ground-truth"></span>
                <span>Ground Truth Change Points</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker otava-detected"></span>
                <span>Otava Detected</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker false-positive"></span>
                <span>False Positive</span>
            </div>
        </section>

        <!-- Main Chart -->
        <section class="chart-container">
            <canvas id="main-chart"></canvas>
        </section>

        <!-- Accuracy Metrics -->
        <section class="accuracy-metrics" id="accuracy-metrics">
            <h3>Detection Accuracy</h3>
            <div class="metrics-grid">
                <div class="metric-card precision">
                    <h4>Precision</h4>
                    <span id="metric-precision">-</span>
                    <p class="metric-desc">Correct / All Detected</p>
                </div>
                <div class="metric-card recall">
                    <h4>Recall</h4>
                    <span id="metric-recall">-</span>
                    <p class="metric-desc">Detected / All True</p>
                </div>
                <div class="metric-card f1">
                    <h4>F1 Score</h4>
                    <span id="metric-f1">-</span>
                    <p class="metric-desc">Harmonic Mean</p>
                </div>
                <div class="metric-card counts">
                    <h4>Counts</h4>
                    <div class="count-details">
                        <span>TP: <strong id="metric-tp">-</strong></span>
                        <span>FP: <strong id="metric-fp">-</strong></span>
                        <span>FN: <strong id="metric-fn">-</strong></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Basic Stats -->
        <section class="stats" id="stats">
            <div class="stat-card">
                <h4>Data Points</h4>
                <span id="stat-length">-</span>
            </div>
            <div class="stat-card">
                <h4>Mean</h4>
                <span id="stat-mean">-</span>
            </div>
            <div class="stat-card">
                <h4>Std Dev</h4>
                <span id="stat-std">-</span>
            </div>
            <div class="stat-card">
                <h4>Ground Truth CPs</h4>
                <span id="stat-cp-truth">-</span>
            </div>
            <div class="stat-card">
                <h4>Otava Detected</h4>
                <span id="stat-cp-detected">-</span>
            </div>
        </section>

        <!-- Change Points Comparison Table -->
        <section class="change-points-detail" id="change-points-detail">
            <h3>Change Points Comparison</h3>
            <div class="comparison-tables">
                <div class="table-wrapper">
                    <h4>Ground Truth</h4>
                    <table id="truth-table">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Matched?</th>
                            </tr>
                        </thead>
                        <tbody id="truth-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="table-wrapper">
                    <h4>Otava Detected</h4>
                    <table id="detected-table">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Mean Before</th>
                                <th>Mean After</th>
                                <th>P-Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="detected-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Multi-chart view for "Show All" -->
        <section class="multi-chart-container hidden" id="multi-chart-container">
            <h2>All Test Patterns - Otava Comparison</h2>
            <div class="summary-stats" id="summary-stats">
                <!-- Overall accuracy summary will be inserted here -->
            </div>
            <div class="chart-grid" id="chart-grid">
                <!-- Charts will be dynamically inserted -->
            </div>
        </section>
    </main>

    <footer>
        <p>
            <a href="https://github.com/apache/otava" target="_blank">Apache Otava</a> |
            Change point detection benchmarking and visualization
        </p>
    </footer>

    <script src="/static/js/app.js"></script>
</body>
</html>
