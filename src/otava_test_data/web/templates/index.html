<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otava Test Data Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>Otava Test Data Visualizer</h1>
        <p class="subtitle">Interactive visualization of change point detection with Apache Otava</p>
    </header>

    <main>
        <!-- Data Generation Controls -->
        <section class="controls top-controls">
            <div class="control-group generator-group">
                <label for="generator-select">Generator:</label>
                <select id="generator-select">
                    <optgroup label="Clean Patterns (No Noise)">
                        {% for name, info in generators.items() if info.category == 'clean' %}
                        <option value="{{ name }}" data-has-cp="{{ info.has_change_points|lower }}">
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Basic Building Blocks">
                        {% for name, info in generators.items() if info.category == 'basic' %}
                        <option value="{{ name }}" data-has-cp="{{ info.has_change_points|lower }}">
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Advanced Patterns">
                        {% for name, info in generators.items() if info.category == 'advanced' %}
                        <option value="{{ name }}" data-has-cp="{{ info.has_change_points|lower }}">
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>

            <div class="control-group length-group">
                <label for="length-input">Length:</label>
                <div class="slider-with-bounds">
                    <input type="number" id="length-min" class="bound-input" value="50" min="10" max="5000" step="10" title="Min bound">
                    <input type="range" id="length-slider" min="50" max="1000" value="{{ default_length }}" step="10">
                    <input type="number" id="length-max" class="bound-input" value="1000" min="10" max="5000" step="10" title="Max bound">
                    <input type="number" id="length-input" class="value-input" value="{{ default_length }}" min="50" max="1000" step="10">
                </div>
            </div>

            <div class="control-group seed-group">
                <label for="seed-input">Seed:</label>
                <input type="number" id="seed-input" class="seed-input" value="42" min="0" max="9999">
            </div>

            <div id="dynamic-params" class="dynamic-params">
                <!-- Dynamic parameters will be inserted here -->
            </div>
        </section>

        <!-- Analysis Controls Wrapper -->
        <section class="analysis-wrapper">
            <h3 class="section-title">Analysis Controls</h3>

            <div class="analysis-toolbar">
                <div class="control-actions">
                    <button id="generate-btn" class="btn-primary">Analyse</button>
                    <button id="show-all-btn" class="btn-secondary">Show All Graphs</button>
                </div>

                <div class="control-group y-axis-group">
                    <label for="y-min-input">Y-Axis Min:</label>
                    <div class="slider-with-bounds">
                        <input type="number" id="y-min-bound-min" class="bound-input" value="0" min="-1000" max="1000" step="10" title="Min bound">
                        <input type="range" id="y-min-slider" min="0" max="500" value="40" step="10">
                        <input type="number" id="y-min-bound-max" class="bound-input" value="500" min="-1000" max="1000" step="10" title="Max bound">
                        <input type="number" id="y-min-input" class="value-input" value="40" min="0" max="500" step="10">
                    </div>
                </div>

                <div class="control-group y-axis-group">
                    <label for="y-max-input">Y-Axis Max:</label>
                    <div class="slider-with-bounds">
                        <input type="number" id="y-max-bound-min" class="bound-input" value="0" min="-1000" max="1000" step="10" title="Min bound">
                        <input type="range" id="y-max-slider" min="0" max="500" value="160" step="10">
                        <input type="number" id="y-max-bound-max" class="bound-input" value="500" min="-1000" max="1000" step="10" title="Max bound">
                        <input type="number" id="y-max-input" class="value-input" value="160" min="0" max="500" step="10">
                    </div>
                </div>
            </div>

            <div class="analysis-panels">
                <!-- Otava Analysis Controls -->
                <div class="controls otava-controls">
                    <div class="panel-header">
                        <label for="run-otava-checkbox" class="panel-title">Otava Analysis</label>
                        <input type="checkbox" id="run-otava-checkbox" checked>
                    </div>

                    <div class="panel-fields">
                        <div class="control-group">
                            <label for="window-len-input">Window Length</label>
                            <input type="number" id="window-len-input" value="30" min="5" max="100" step="5">
                        </div>
                        <div class="control-group">
                            <label for="max-pvalue-input">Max P-Value</label>
                            <input type="number" id="max-pvalue-input" value="0.05" min="0.001" max="1.0" step="0.01">
                        </div>
                    </div>
                </div>

                <!-- Moving Average Analysis Controls -->
                <div class="controls ma-controls">
                    <div class="panel-header">
                        <label for="run-ma-checkbox" class="panel-title">Moving Average Analysis</label>
                        <input type="checkbox" id="run-ma-checkbox">
                    </div>
                    <div class="panel-fields">
                        <div class="control-group">
                            <label for="ma-window-input">MA Window</label>
                            <input type="number" id="ma-window-input" value="10" min="3" max="50" step="1">
                        </div>
                        <div class="control-group">
                            <label for="ma-threshold-input">Threshold (Ïƒ)</label>
                            <input type="number" id="ma-threshold-input" value="2.0" min="0.5" max="5.0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Boundary Analysis Controls -->
                <div class="controls boundary-controls">
                    <div class="panel-header">
                        <label for="run-boundary-checkbox" class="panel-title">Boundary Analysis</label>
                        <input type="checkbox" id="run-boundary-checkbox">
                    </div>
                    <div class="panel-fields">
                        <div class="control-group">
                            <label for="boundary-upper-input">Upper Bound</label>
                            <input type="number" id="boundary-upper-input" value="115" min="0" max="500" step="5">
                        </div>
                        <div class="control-group">
                            <label for="boundary-lower-input">Lower Bound</label>
                            <input type="number" id="boundary-lower-input" value="85" min="0" max="500" step="5">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Generator Info -->
        <section class="generator-info" id="generator-info">
            <h3 id="generator-title">Constant</h3>
            <p id="generator-description">Constant value: S = x, x, x, x...</p>
            <div id="change-point-info" class="change-point-badge hidden">
                <span class="badge">Has Change Points</span>
            </div>
        </section>

        <!-- Chart Legend -->
        <section class="chart-legend">
            <div class="legend-item">
                <span class="legend-line ground-truth"></span>
                <span>Ground Truth</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker otava-detected"></span>
                <span>Otava (TP)</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker false-positive"></span>
                <span>Otava (FP)</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker ma-detected"></span>
                <span>MA (TP)</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker ma-false-positive"></span>
                <span>MA (FP)</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker boundary-detected"></span>
                <span>Boundary (TP)</span>
            </div>
            <div class="legend-item">
                <span class="legend-marker boundary-false-positive"></span>
                <span>Boundary (FP)</span>
            </div>
        </section>

        <!-- Stacked Charts Container -->
        <section class="stacked-charts-container" id="stacked-charts-container">
            <!-- Charts will be dynamically inserted based on enabled analysis methods -->
        </section>

        <!-- Accuracy Metrics -->
        <section class="accuracy-metrics" id="accuracy-metrics">
            <h3>Detection Accuracy</h3>
            <div class="metrics-grid">
                <div class="metric-card precision">
                    <h4>Precision</h4>
                    <span id="metric-precision">-</span>
                    <p class="metric-desc">Correct / All Detected</p>
                </div>
                <div class="metric-card recall">
                    <h4>Recall</h4>
                    <span id="metric-recall">-</span>
                    <p class="metric-desc">Detected / All True</p>
                </div>
                <div class="metric-card f1">
                    <h4>F1 Score</h4>
                    <span id="metric-f1">-</span>
                    <p class="metric-desc">Harmonic Mean</p>
                </div>
                <div class="metric-card counts">
                    <h4>Counts</h4>
                    <div class="count-details">
                        <span>TP: <strong id="metric-tp">-</strong></span>
                        <span>FP: <strong id="metric-fp">-</strong></span>
                        <span>FN: <strong id="metric-fn">-</strong></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Basic Stats -->
        <section class="stats" id="stats">
            <div class="stat-card">
                <h4>Data Points</h4>
                <span id="stat-length">-</span>
            </div>
            <div class="stat-card">
                <h4>Mean</h4>
                <span id="stat-mean">-</span>
            </div>
            <div class="stat-card">
                <h4>Std Dev</h4>
                <span id="stat-std">-</span>
            </div>
            <div class="stat-card">
                <h4>Ground Truth CPs</h4>
                <span id="stat-cp-truth">-</span>
            </div>
            <div class="stat-card">
                <h4>Otava Detected</h4>
                <span id="stat-cp-detected">-</span>
            </div>
        </section>

        <!-- Change Points Comparison Table -->
        <section class="change-points-detail" id="change-points-detail">
            <h3>Change Points Comparison</h3>
            <div class="comparison-tables">
                <div class="table-wrapper">
                    <h4>Ground Truth</h4>
                    <table id="truth-table">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Matched?</th>
                            </tr>
                        </thead>
                        <tbody id="truth-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="table-wrapper">
                    <h4>Otava Detected</h4>
                    <table id="detected-table">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Mean Before</th>
                                <th>Mean After</th>
                                <th>P-Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="detected-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Multi-chart view for "Show All" -->
        <section class="multi-chart-container hidden" id="multi-chart-container">
            <h2>All Test Patterns - Otava Comparison</h2>
            <div class="summary-stats" id="summary-stats">
                <!-- Overall accuracy summary will be inserted here -->
            </div>
            <div class="chart-grid" id="chart-grid">
                <!-- Charts will be dynamically inserted -->
            </div>
        </section>
    </main>

    <footer>
        <p>
            <a href="https://github.com/apache/otava" target="_blank">Apache Otava</a> |
            Change point detection benchmarking and visualization
        </p>
    </footer>

    <script src="/static/js/app.js"></script>
</body>
</html>
